{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block title %}
<title>Checkout | Aviation Spares & Repairs</title>
{% endblock %}
{% block content %}
    <div class="bg-gray-50 py-3 border-b">
        <div class="container mx-auto px-4">
            <nav class="flex text-sm">
                <a href="{% url 'product:home' %}" class="text-aviation-blue hover:underline">Home</a>
                <span class="mx-2 text-gray-400">/</span>
                <span class="text-gray-600">Checkout</span>
            </nav>
        </div>
    </div>

    <main class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">Checkout</h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Cart Items -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded shadow p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Your Order</h2>
                    {% if cart_products %}
                    <div id="cart-items" class="space-y-4">
                        {% for x in cart_products %}
                        <div class="flex items-center justify-between border-b pb-4" data-product-id="{{ x.id }}" data-total-price="{{ x.total_price }}">
                            <div class="flex items-center space-x-4">

                                <img src="{{x.product_obj.product_pic}}" alt="{{x.product_obj.product_name}}" class="w-16 h-16 object-contain rounded bg-gray-100 p-1">
                                <div>
                                    <a href="{% url 'product:product_detail' x.id %}"><h3 class="font-medium text-gray-800">{{x.product_obj.product_name}}</h3></a>
                                    <p class="text-sm text-gray-500">Qty: {{x.quantity}}</p>
                                    <p class="text-sm text-gray-600 font-bold">£{{x.total_price|floatformat:2|intcomma}}</p>
                                </div>
                            </div>
                            <button class="remove-from-cart text-red-500 hover:text-red-700" >
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div id="empty-cart" class="text-center py-8 hidden">
                        <i class="fas fa-shopping-cart text-gray-300 text-4xl mb-4"></i>
                        <p class="text-gray-500">Your cart is empty</p>
                        <a href="{% url 'product:home' %}" class="inline-block mt-4 bg-aviation-blue text-white px-6 py-2 rounded hover:bg-blue-700">Continue Shopping</a>
                    </div>
                  {% endif %}
                </div>

                <!-- Billing Information -->
                <div class="bg-white rounded shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Billing Information</h2>
                    <form id="checkout-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                                <input type="text" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-aviation-blue">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                                <input type="text" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-aviation-blue">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
                            <input type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-aviation-blue">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <input type="email" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-aviation-blue">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                            <input type="tel" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-aviation-blue">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                            <input type="text" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-aviation-blue">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
                                <input type="text" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-aviation-blue">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">County</label>
                                <input type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-aviation-blue">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Postcode</label>
                                <input type="text" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-aviation-blue">
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded shadow p-6 sticky top-4">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Order Summary</h2>
                    <div class="space-y-3 mb-4">
                        <div class="flex justify-between">
                            <span>Subtotal:</span>
                            <span id="subtotal">£{{subtotal|floatformat:2|intcomma}}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>VAT (20%):</span>
                            <span id="vat">£{{vat|floatformat:2|intcomma}}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Shipping:</span>
                            <span id="shipping">FREE</span>
                        </div>
                        <hr>
                        <div class="flex justify-between font-bold text-lg">
                            <span>Total:</span>
                            <span id="total">£{{total_sum|floatformat:2|intcomma}}</span>
                        </div>
                    </div>

                    <a href="{% url 'cart:cart_message' %}">
                    <button id="place-order" class="w-full bg-aviation-blue text-white font-bold py-3 px-4 rounded hover:bg-blue-700 transition-colors mb-4">
                        Place Order
                    </button>
                    </a>

                    <div class="text-xs text-gray-500 text-center">
                        <p class="mb-2">Secure checkout powered by SSL encryption</p>
                        <div class="flex justify-center space-x-2">
                            <i class="fab fa-cc-visa text-lg"></i>
                            <i class="fab fa-cc-mastercard text-lg"></i>
                            <i class="fab fa-cc-paypal text-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
<script>
document.querySelectorAll(".remove-from-cart").forEach(button => {
    button.addEventListener("click", function () {
        // Get product ID and parent div
        const parentDiv = this.closest("[data-product-id]");
        if (!parentDiv) return;

        const productId = parentDiv.dataset.productId;
        if (!productId) return;

        // Get product total price span inside this div (for updating summary)
        const totalPriceSpan = parentDiv.querySelector("[data-total-price]");
        const productTotal = totalPriceSpan ? parseFloat(totalPriceSpan.dataset.totalPrice) : 0;

        fetch("{% url 'cart:cart_delete' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: new URLSearchParams({
                action: "post",
                product_id: productId
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                parentDiv.remove();

                const cartCount = document.getElementById("cart-count");
                if (cartCount) cartCount.textContent = data.total_quantity;

                document.getElementById("subtotal").textContent = `£${parseFloat(data.subtotal).toFixed(2)}`;
                document.getElementById("vat").textContent = `£${parseFloat(data.vat).toFixed(2)}`;
                document.getElementById("total").textContent = `£${parseFloat(data.total_sum).toFixed(2)}`;
            }
        })

        .catch(err => console.error("Cart delete error:", err));
    });
});
</script>

{% endblock %}
